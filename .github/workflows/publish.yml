name: Publish Data Product (Snowflake + Terraform)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev/uat/prod)"
        required: true
        type: choice
        options: [dev, uat, prod]
        default: dev
      apply:
        description: "Apply Terraform (true) or plan only (false)"
        required: true
        type: boolean
        default: false
      execute_sql:
        description: "Execute rendered SQL with Snowflake CLI"
        required: true
        type: boolean
        default: false
      create_database:
        description: "Create DB from product.yml (needs privilege)"
        required: true
        type: boolean
        default: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      # -----------------------------------------------------------
      # 1. Checkout the repository
      # -----------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2. Validate required secrets
      # -----------------------------------------------------------
      - name: Validate required Snowflake secrets
        env:
          SNOWFLAKE_ACCOUNT_LOCATOR: ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          SNOWFLAKE_REGION:           ${{ secrets.SNOWFLAKE_REGION }}
          SNOWFLAKE_USER:             ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:         ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:             ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          : "${SNOWFLAKE_ACCOUNT_LOCATOR:?Missing SNOWFLAKE_ACCOUNT_LOCATOR secret (e.g. UE47735)}"
          : "${SNOWFLAKE_REGION:?Missing SNOWFLAKE_REGION secret (e.g. europe-west4.gcp)}"
          : "${SNOWFLAKE_USER:?Missing SNOWFLAKE_USER secret}"
          : "${SNOWFLAKE_PASSWORD:?Missing SNOWFLAKE_PASSWORD secret}"
          : "${SNOWFLAKE_ROLE:?Missing SNOWFLAKE_ROLE secret}"
          echo "âœ… All required secrets found."

      # -----------------------------------------------------------
      # 3. Setup Python (for Snowflake CLI, runner scripts, etc.)
      # -----------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI and yq
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          sudo apt-get update && sudo apt-get install -y yq

      # -----------------------------------------------------------
      # 4. Configure Snowflake CLI connection
      # -----------------------------------------------------------
      - name: Configure Snowflake CLI connection
        env:
          SF_ACCOUNT:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          SF_REGION:   ${{ secrets.SNOWFLAKE_REGION }}
          SF_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS:     ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          mkdir -p "$HOME/.snowflake"
          cat > "$HOME/.snowflake/config.toml" <<EOF
          default_connection_name = "ci"

          [connections]
            [connections.ci]
            account  = "${SF_ACCOUNT}"
            region   = "${SF_REGION}"
            user     = "${SF_USER}"
            password = "${SF_PASS}"
            role     = "${SF_ROLE}"
          EOF
                    chmod 600 "$HOME/.snowflake/config.toml"
                    echo "âœ… Snowflake CLI configured for ${SF_ACCOUNT}.${SF_REGION}"

      # -----------------------------------------------------------
      # 5. Probe connection
      # -----------------------------------------------------------
      - name: Probe Snowflake session identity (CLI)
        run: |
          snow sql -q "
            SELECT
              CURRENT_ORGANIZATION_NAME() AS ORG,
              CURRENT_ACCOUNT_NAME()      AS ACCT,
              CURRENT_ACCOUNT()           AS ACCOUNT_LOCATOR,
              CURRENT_REGION()            AS REGION,
              CURRENT_USER()              AS USERNAME,
              CURRENT_ROLE()              AS ROLE;
          "

      # -----------------------------------------------------------
      # 6. Setup Terraform
      # -----------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Terraform Init
        working-directory: terraform
        env:
          snowflake_account:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          snowflake_region:   ${{ secrets.SNOWFLAKE_REGION }}
          snowflake_user:     ${{ secrets.SNOWFLAKE_USER }}
          snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}
          snowflake_role:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          terraform init -upgrade -reconfigure
          terraform validate

      # -----------------------------------------------------------
      # 7. Terraform Plan
      # -----------------------------------------------------------
      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_INPUT: "false"
          snowflake_account:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          snowflake_region:   ${{ secrets.SNOWFLAKE_REGION }}
          snowflake_user:     ${{ secrets.SNOWFLAKE_USER }}
          snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}
          snowflake_role:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          echo "ðŸ” Using account: ${snowflake_account}.${snowflake_region}"
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "ðŸ“˜ DB from manifest: ${DB_NAME}"
          terraform plan -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360" \
            -var "snowflake_account=${snowflake_account}" \
            -var "snowflake_region=${snowflake_region}" \
            -var "snowflake_user=${snowflake_user}" \
            -var "snowflake_password=${snowflake_password}" \
            -var "snowflake_role=${snowflake_role}"

      # -----------------------------------------------------------
      # 8. Terraform Apply (if requested)
      # -----------------------------------------------------------
      - name: Terraform Apply
        if: ${{ github.event.inputs.apply == 'true' }}
        working-directory: terraform
        env:
          TF_INPUT: "false"
          snowflake_account:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          snowflake_region:   ${{ secrets.SNOWFLAKE_REGION }}
          snowflake_user:     ${{ secrets.SNOWFLAKE_USER }}
          snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}
          snowflake_role:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "ðŸš€ Applying Terraform for ${DB_NAME}"
          terraform apply -auto-approve -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360" \
            -var "snowflake_account=${snowflake_account}" \
            -var "snowflake_region=${snowflake_region}" \
            -var "snowflake_user=${snowflake_user}" \
            -var "snowflake_password=${snowflake_password}" \
            -var "snowflake_role=${snowflake_role}"

      # -----------------------------------------------------------
      # 9. Execute SQL files (if selected)
      # -----------------------------------------------------------
      - name: Execute SQL scripts via Snowflake CLI
        if: ${{ github.event.inputs.apply == 'true' && github.event.inputs.execute_sql == 'true' }}
        run: |
          echo "â–¶ Executing SQL files from build/sql/"
          shopt -s nullglob
          for f in build/sql/*.sql; do
            echo "ðŸ’¡ Running: $f"
            snow sql -f "$f"
          done

      # -----------------------------------------------------------
      # 10. Upload artifacts
      # -----------------------------------------------------------
      - name: Upload rendered SQL
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-sql
          path: build/sql