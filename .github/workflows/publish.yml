name: Publish Data Product (Snowflake + Terraform)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev/uat/prod)"
        required: true
        type: choice
        options: [dev, uat, prod]
        default: dev
      apply:
        description: "Apply Terraform (true) or plan only (false)"
        required: true
        type: boolean
        default: false
      execute_sql:
        description: "Execute rendered SQL with Snowflake CLI"
        required: true
        type: boolean
        default: false
      create_database:
        description: "Create DB from product.yml (needs privilege)"
        required: true
        type: boolean
        default: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      # ---
      # CORRECTED VALIDATION STEP:
      # Switched to 'test -n' to correctly fail if secrets are empty strings.
      # ---
      - name: Validate Snowflake secrets
        env:
          LOCATOR: ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          REGION:  ${{ secrets.SNOWFLAKE_REGION }}
          USER:    ${{ secrets.SNOWFLAKE_USER }}
          PASS:    ${{ secrets.SNOWFLAKE_PASSWORD }}
          ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          echo "Validating secrets..."
          test -n "$LOCATOR" || { echo "❌ ERROR: SNOWFLAKE_ACCOUNT_LOCATOR is empty."; exit 1; }
          test -n "$REGION"  || { echo "❌ ERROR: SNOWFLAKE_REGION is empty."; exit 1; }
          test -n "$USER"    || { echo "❌ ERROR: SNOWFLAKE_USER is empty."; exit 1; }
          test -n "$PASS"    || { echo "❌ ERROR: SNOWFLAKE_PASSWORD is empty."; exit 1; }
          test -n "$ROLE"    || { echo "❌ ERROR: SNOWFLAKE_ROLE is empty."; exit 1; }
          echo "✅ Secrets verified."

      # ---
      # CORRECTED EXPORT STEP:
      # Added id: set_env_vars and switched to $GITHUB_OUTPUT for robust variable passing.
      # ---
      - name: Export Snowflake ENV
        id: set_env_vars
        run: |
          LOCATOR='${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}'
          REGION='${{ secrets.SNOWFLAKE_REGION }}'
          echo "SNOWFLAKE_ACCOUNT=${LOCATOR}.${REGION}" >> $GITHUB_OUTPUT
          echo "SF_LOCATOR=${LOCATOR}" >> $GITHUB_OUTPUT
          echo "SF_REGION=${REGION}" >> $GITHUB_OUTPUT
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}" >> $GITHUB_OUTPUT
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> $GITHUB_OUTPUT
          echo "SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI & yq
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          sudo apt-get update && sudo apt-get install -y yq

      # ---
      # CORRECTED CLI STEP:
      # Explicitly reads variables from the 'set_env_vars' step output.
      # ---
      - name: Configure Snowflake CLI
        env:
          SF_LOCATOR: ${{ steps.set_env_vars.outputs.SF_LOCATOR }}
          SF_REGION: ${{ steps.set_env_vars.outputs.SF_REGION }}
          SNOWFLAKE_USER: ${{ steps.set_env_vars.outputs.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ steps.set_env_vars.outputs.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ steps.set_env_vars.outputs.SNOWFLAKE_ROLE }}
        run: |
          mkdir -p "$HOME/.snowflake"
          cat > "$HOME/.snowflake/config.toml" <<EOF
          default_connection_name = "ci"

          [connections]
            [connections.ci]
            account  = "${SF_LOCATOR}"
            region   = "${SF_REGION}"
            user     = "${SNOWFLAKE_USER}"
            password = "${SNOWFLAKE_PASSWORD}"
            role     = "${SNOWFLAKE_ROLE}"
          EOF
          chmod 600 "$HOME/.snowflake/config.toml"
          echo "✅ Snowflake CLI configured"

      - name: Probe Snowflake identity (CLI)
        run: |
          snow sql -q "
            SELECT
              CURRENT_ACCOUNT() AS ACCOUNT_LOCATOR,
              CURRENT_REGION()  AS REGION,
              CURRENT_USER()    AS USERNAME,
              CURRENT_ROLE()    AS ROLE;
          "

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      # ---
      # CORRECTED TERRAFORM STEPS:
      # All Terraform steps now explicitly read variables from the 'set_env_vars' step output.
      # ---
      # ---
      # CORRECTED STEP:
      # Added -cloud=false to 'terraform init' to force a local run.
      # This ensures Terraform uses the local GitHub runner's environment variables
      # instead of trying to run remotely in Terraform Cloud.
      # ---
      - name: Terraform Init
        working-directory: terraform
        env:
          SNOWFLAKE_ACCOUNT:  ${{ steps.set_env_vars.outputs.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ steps.set_env_vars.outputs.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_ROLE }}
        run: |
          rm -rf .terraform .terraform.lock.hcl
          # Force local execution, ignoring any 'cloud {}' backend
          terraform init -upgrade -reconfigure -cloud=false
          terraform validate

      - name: Debug provider ENV
        working-directory: terraform
        env:
          SNOWFLAKE_ACCOUNT:  ${{ steps.set_env_vars.outputs.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_ROLE }}
        run: |
          echo "--- DEBUGGING ENV (from step outputs) ---"
          echo "SNOWFLAKE_ACCOUNT: [${SNOWFLAKE_ACCOUNT}]"
          echo "SNOWFLAKE_USER: [${SNOWFLAKE_USER}]"
          echo "SNOWFLAKE_ROLE: [${SNOWFLAKE_ROLE}]"
          echo "--- END DEBUGGING ---"
          test -n "$SNOWFLAKE_ACCOUNT"

      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_INPUT: "false"
          SNOWFLAKE_ACCOUNT:  ${{ steps.set_env_vars.outputs.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ steps.set_env_vars.outputs.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "DB from manifest: ${DB_NAME}"
          terraform plan -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER3C0_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Terraform Apply
        if: ${{ github.event.inputs.apply == 'true' }}
        working-directory: terraform
        env:
          TF_INPUT: "false"
          SNOWFLAKE_ACCOUNT:  ${{ steps.set_env_vars.outputs.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ steps.set_env_vars.outputs.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ steps.set_env_vars.outputs.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "Applying for DB: ${DB_NAME}"
          terraform apply -auto-approve -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"