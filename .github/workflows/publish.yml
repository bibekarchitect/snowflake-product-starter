name: Publish Data Product (Snowflake via profile+host)
'on':
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
          - dev
          - uat
          - prod
        default: dev
      apply:
        type: boolean
        default: false
      execute_sql:
        type: boolean
        default: false
      create_database:
        type: boolean
        default: false
jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: '${{ github.event.inputs.environment }}'
    steps:
      - uses: actions/checkout@v4
      - name: Validate secrets
        env:
          LOCATOR: '${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}'
          REGION: '${{ secrets.SNOWFLAKE_REGION }}'
          USER: '${{ secrets.SNOWFLAKE_USER }}'
          PASSWORD: '${{ secrets.SNOWFLAKE_PASSWORD }}'
          ROLE: '${{ secrets.SNOWFLAKE_ROLE }}'
        run: |
          : "${LOCATOR:?Missing SNOWFLAKE_ACCOUNT_LOCATOR}"
          : "${REGION:?Missing SNOWFLAKE_REGION}"
          : "${USER:?Missing SNOWFLAKE_USER}"
          : "${PASSWORD:?Missing SNOWFLAKE_PASSWORD}"
          : "${ROLE:?Missing SNOWFLAKE_ROLE}"
          echo "âœ… Secrets present."
      - name: Write Snowflake configs (provider + CLI)
        env:
          LOCATOR: '${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}'
          REGION: '${{ secrets.SNOWFLAKE_REGION }}'
          USER: '${{ secrets.SNOWFLAKE_USER }}'
          PASSWORD: '${{ secrets.SNOWFLAKE_PASSWORD }}'
          ROLE: '${{ secrets.SNOWFLAKE_ROLE }}'
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.snowflake"
          HOST="${LOCATOR}.${REGION}.snowflakecomputing.com"

          # Provider config used by Terraform
          cat > "$HOME/.snowflake/config" <<EOF
          [ci]
          host     = "${HOST}"
          user     = "${USER}"
          password = "${PASSWORD}"
          role     = "${ROLE}"
          EOF
          chmod 600 "$HOME/.snowflake/config"

          # CLI config (snow)
          cat > "$HOME/.snowflake/config.toml" <<EOF
          default_connection_name = "ci"
          [connections]
            [connections.ci]
            host     = "${HOST}"
            user     = "${USER}"
            password = "${PASSWORD}"
            role     = "${ROLE}"
          EOF
          chmod 600 "$HOME/.snowflake/config.toml"

          echo "SNOWFLAKE_CONFIG_PATH=$HOME/.snowflake/config" >> $GITHUB_ENV
          echo "SNOWFLAKE_PROFILE=ci"                          >> $GITHUB_ENV
      - name: Setup Python + CLI + yq
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          sudo apt-get update && sudo apt-get install -y yq
      - name: Probe identity (CLI)
        run: |
          snow --config-file "$HOME/.snowflake/config.toml" sql -q "
            SELECT CURRENT_ACCOUNT(), CURRENT_REGION(), CURRENT_USER(), CURRENT_ROLE();"
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      - name: Terraform Init
        working-directory: terraform
        env:
          SNOWFLAKE_CONFIG_PATH: '${{ env.SNOWFLAKE_CONFIG_PATH }}'
          SNOWFLAKE_PROFILE: '${{ env.SNOWFLAKE_PROFILE }}'
        run: |
          rm -rf .terraform .terraform.lock.hcl
          terraform init -upgrade -reconfigure
          terraform validate
      - name: Debug provider profile usage
        working-directory: terraform
        env:
          SNOWFLAKE_CONFIG_PATH: '${{ env.SNOWFLAKE_CONFIG_PATH }}'
          SNOWFLAKE_PROFILE: '${{ env.SNOWFLAKE_PROFILE }}'
        run: |
          echo "Using $SNOWFLAKE_CONFIG_PATH profile $SNOWFLAKE_PROFILE"
          sed -n '1,120p' "$SNOWFLAKE_CONFIG_PATH"
      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_INPUT: 'false'
          SNOWFLAKE_CONFIG_PATH: '${{ env.SNOWFLAKE_CONFIG_PATH }}'
          SNOWFLAKE_PROFILE: '${{ env.SNOWFLAKE_PROFILE }}'
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "DB from manifest: ${DB_NAME}"
          terraform plan -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"
      - name: Terraform Apply
        if: '${{ github.event.inputs.apply == ''true'' }}'
        working-directory: terraform
        env:
          TF_INPUT: 'false'
          SNOWFLAKE_CONFIG_PATH: '${{ env.SNOWFLAKE_CONFIG_PATH }}'
          SNOWFLAKE_PROFILE: '${{ env.SNOWFLAKE_PROFILE }}'
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          terraform apply -auto-approve -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"
