name: Publish Data Product (Manual, Snowflake CLI + CI Connection)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev/uat/prod)"
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod
        default: dev
      apply:
        description: "Apply Terraform (true) or plan only (false)"
        required: true
        type: boolean
        default: false
      execute_sql:
        description: "Execute rendered SQL with Snowflake CLI"
        required: true
        type: boolean
        default: false
      catalog:
        description: "Generate DataHub recipe artifact"
        required: true
        type: boolean
        default: false
      create_database:
        description: "Create DB from product.yml (needs privilege)"
        required: true
        type: boolean
        default: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      # ---- Ensure required secrets exist in the selected Environment ----
      - name: Validate required secrets
        env:
          SNOWFLAKE_ORG_NAME: ${{ secrets.SNOWFLAKE_ORG_NAME }}
          SNOWFLAKE_ACCOUNT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          : "${SNOWFLAKE_ORG_NAME:?Need SNOWFLAKE_ORG_NAME in this Environment}"
          : "${SNOWFLAKE_ACCOUNT_NAME:?Need SNOWFLAKE_ACCOUNT_NAME in this Environment}"
          : "${SNOWFLAKE_USER:?Need SNOWFLAKE_USER in this Environment}"
          : "${SNOWFLAKE_PASSWORD:?Need SNOWFLAKE_PASSWORD in this Environment}"
          : "${SNOWFLAKE_ROLE:?Need SNOWFLAKE_ROLE in this Environment}"
          echo "All required Snowflake secrets are present."

      # ---- Tooling: Python, Snowflake CLI, repo deps, yq ----
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI + repo deps
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          pip install -r tools/requirements.txt
          sudo apt-get update && sudo apt-get install -y yq

      # ---- Configure Snowflake CLI default connection [connections.ci] ----
      - name: Configure Snowflake CLI default connection
        env:
          ORG_NAME: ${{ secrets.SNOWFLAKE_ORG_NAME }}
          ACCT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SF_USER: ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          mkdir -p "$HOME/.snowflake"
          cat > "$HOME/.snowflake/config.toml" <<'EOF'
          default_connection_name = "ci"

          [connections]
            [connections.ci]
            account  = "__ACCOUNT__"
            user     = "__USER__"
            password = "__PASS__"
            role     = "__ROLE__"
          EOF
                    sed -i "s/__ACCOUNT__/${ORG_NAME}-${ACCT_NAME}/" "$HOME/.snowflake/config.toml"
                    sed -i "s/__USER__/${SF_USER}/" "$HOME/.snowflake/config.toml"
                    sed -i "s/__PASS__/${SF_PASS}/" "$HOME/.snowflake/config.toml"
                    sed -i "s/__ROLE__/${SF_ROLE}/" "$HOME/.snowflake/config.toml"
                    chmod 600 "$HOME/.snowflake/config.toml"
                    echo "Wrote ~/.snowflake/config.toml with default_connection_name=ci"

      # ---- Probe Snowflake session identity via the default connection ----
      - name: Probe Snowflake session identity
        run: |
          snow sql -q "
            SELECT
              CURRENT_ORGANIZATION_NAME() AS ORG,
              CURRENT_ACCOUNT_NAME()      AS ACCT,
              CURRENT_ACCOUNT()           AS ACCOUNT_LOCATOR,
              CURRENT_REGION()            AS REGION,
              CURRENT_USER()              AS USERNAME,
              CURRENT_ROLE()              AS ROLE;
          "

      # ---- Terraform ----
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Terraform Init & Validate
        working-directory: terraform
        run: |
          terraform init -upgrade
          terraform validate

      - name: Terraform Plan (explicit vars)
        working-directory: terraform
        env:
          ORG_NAME: ${{ secrets.SNOWFLAKE_ORG_NAME }}
          ACCT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SF_USER: ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq '.layout.database' ../product.yml)"
          terraform plan \
            -var "snowflake_org_name=${ORG_NAME}" \
            -var "snowflake_account_name=${ACCT_NAME}" \
            -var "snowflake_user=${SF_USER}" \
            -var "snowflake_password=${SF_PASS}" \
            -var "snowflake_role=${SF_ROLE}" \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Render SQL (dry-run)
        run: python tools/runner.py render --manifest product.yml --out build/sql --dry-run

      - name: Terraform Apply (explicit vars)
        if: ${{ github.event.inputs.apply == 'true' }}
        working-directory: terraform
        env:
          ORG_NAME: ${{ secrets.SNOWFLAKE_ORG_NAME }}
          ACCT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SF_USER: ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq '.layout.database' ../product.yml)"
          terraform apply -auto-approve \
            -var "snowflake_org_name=${ORG_NAME}" \
            -var "snowflake_account_name=${ACCT_NAME}" \
            -var "snowflake_user=${SF_USER}" \
            -var "snowflake_password=${SF_PASS}" \
            -var "snowflake_role=${SF_ROLE}" \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Render SQL (apply mode)
        if: ${{ github.event.inputs.apply == 'true' }}
        run: python tools/runner.py render --manifest product.yml --out build/sql

      # ---- Execute SQL using Snowflake CLI (uses default connection) ----
      - name: Execute SQL (snow CLI)
        if: ${{ github.event.inputs.apply == 'true' && github.event.inputs.execute_sql == 'true' }}
        run: |
          shopt -s nullglob
          for f in build/sql/*.sql; do
            echo "==> $f"
            snow sql -f "$f"
          done

      # ---- Artifacts ----
      - name: Upload rendered SQL
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-sql
          path: build/sql

      - name: Generate DataHub recipe
        if: ${{ github.event.inputs.catalog == 'true' }}
        run: python tools/runner.py catalog --manifest product.yml

      - name: Upload DataHub recipe
        if: ${{ github.event.inputs.catalog == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: datahub-recipe
          path: build/datahub_snowflake_recipe.yml