name: Publish Data Product (Manual, Explicit Vars)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev/uat/prod)"
        required: true
        type: choice
        options: [dev, uat, prod]
        default: dev
      apply:
        description: "Apply Terraform (true) or plan only (false)"
        required: true
        type: boolean
        default: false
      execute_sql:
        description: "Install SnowSQL & execute rendered SQL"
        required: true
        type: boolean
        default: false
      catalog:
        description: "Generate DataHub recipe artifact"
        required: true
        type: boolean
        default: false
      create_database:
        description: "Create DB from product.yml (needs privilege)"
        required: true
        type: boolean
        default: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Install SnowSQL (probe)
        run: |
         curl -sSfL https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.29-linux_x86_64.bash -o snowsql.bash
         bash snowsql.bash -y -i ./snowsql
         echo "$GITHUB_WORKSPACE/snowsql/bin" >> $GITHUB_PATH

      - name: Probe Snowflake session identity
        env:
        # If youâ€™re on the new provider (org/account model), compose the identifier for SnowSQL.
         SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ORG_NAME }}-${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
         SNOWSQL_USER:    ${{ secrets.SNOWFLAKE_USER }}
         SNOWSQL_PWD:     ${{ secrets.SNOWFLAKE_PASSWORD }}
         SNOWSQL_ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
         snowsql -o friendly=false -q "
          SELECT
            CURRENT_ORGANIZATION_NAME()   AS ORG,
            CURRENT_ACCOUNT_NAME()        AS ACCT,
            CURRENT_ACCOUNT()             AS ACCOUNT_LOCATOR,
            CURRENT_REGION()              AS REGION,
            CURRENT_USER()                AS USERNAME,
            CURRENT_ROLE()                AS ROLE;
        "

      # ---- Fail fast if required secrets are missing in the selected Environment ----
      - name: Validate Snowflake secrets (env-level)
        env:
          SNOWFLAKE_ORG_NAME:     ${{ secrets.SNOWFLAKE_ORG_NAME }}
          SNOWFLAKE_ACCOUNT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_USER:         ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:     ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:         ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          : "${SNOWFLAKE_ORG_NAME:?Need SNOWFLAKE_ORG_NAME in this Environment}"
          : "${SNOWFLAKE_ACCOUNT_NAME:?Need SNOWFLAKE_ACCOUNT_NAME in this Environment}"
          : "${SNOWFLAKE_USER:?Need SNOWFLAKE_USER in this Environment}"
          : "${SNOWFLAKE_PASSWORD:?Need SNOWFLAKE_PASSWORD in this Environment}"
          : "${SNOWFLAKE_ROLE:?Need SNOWFLAKE_ROLE in this Environment}"
          echo "All required Snowflake secrets are present."

      # (Optional) masked probe (doesn't print values)
      - name: Probe secrets presence (masked)
        env:
          SNOWFLAKE_ORG_NAME:     ${{ secrets.SNOWFLAKE_ORG_NAME }}
          SNOWFLAKE_ACCOUNT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_USER:         ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:     ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:         ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          for v in SNOWFLAKE_ORG_NAME SNOWFLAKE_ACCOUNT_NAME SNOWFLAKE_USER SNOWFLAKE_PASSWORD SNOWFLAKE_ROLE; do
            if [ -n "${!v}" ]; then echo "$v=SET"; else echo "$v=EMPTY"; fi
          done

      # ---- Tooling ----
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (Python, yq)
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/requirements.txt
          sudo apt-get update && sudo apt-get install -y yq

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      # ---- Terraform init/validate ----
      - name: Terraform Init & Validate
        working-directory: terraform
        run: |
          terraform init -upgrade
          terraform validate

      # ---- Plan with explicit -var credentials (no env autodiscovery) ----
      - name: Terraform Plan
        working-directory: terraform
        env:
          ORG_NAME:   ${{ secrets.SNOWFLAKE_ORG_NAME }}      # e.g., XYAUPKY
          ACCT_NAME:  ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}  # e.g., XH85556
          SF_USER:    ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS:    ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq '.layout.database' ../product.yml)"
          terraform plan \
            -var "snowflake_org_name=${ORG_NAME}" \
            -var "snowflake_account_name=${ACCT_NAME}" \
            -var "snowflake_user=${SF_USER}" \
            -var "snowflake_password=${SF_PASS}" \
            -var "snowflake_role=${SF_ROLE}" \
            -var create_database=${{ github.event.inputs.create_database }} \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var 'resource_monitor={"name":"RM_CUSTOMER360","monthly_credits_cap":500,"notify_at":[70,90,100]}'

      - name: Render SQL (dry-run)
        run: python tools/runner.py render --manifest product.yml --out build/sql --dry-run

      # ---- Apply infra ----
      - name: Terraform Apply
        if: ${{ inputs.apply == true }}
        working-directory: terraform
        env:
          ORG_NAME:   ${{ secrets.SNOWFLAKE_ORG_NAME }}
          ACCT_NAME:  ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SF_USER:    ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS:    ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq '.layout.database' ../product.yml)"
          terraform apply -auto-approve \
            -var "snowflake_org_name=${ORG_NAME}" \
            -var "snowflake_account_name=${ACCT_NAME}" \
            -var "snowflake_user=${SF_USER}" \
            -var "snowflake_password=${SF_PASS}" \
            -var "snowflake_role=${SF_ROLE}" \
            -var create_database=${{ github.event.inputs.create_database }} \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var 'resource_monitor={"name":"RM_CUSTOMER360","monthly_credits_cap":500,"notify_at":[70,90,100]}'

      - name: Render SQL
        if: ${{ inputs.apply == true }}
        run: python tools/runner.py render --manifest product.yml --out build/sql

      # ---- Optional: execute SQL via SnowSQL ----
      - name: Install SnowSQL
        if: ${{ inputs.apply == true && inputs.execute_sql == true }}
        run: |
          curl -sSfL https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.29-linux_x86_64.bash -o snowsql.bash
          bash snowsql.bash -y -i ./snowsql
          echo "$GITHUB_WORKSPACE/snowsql/bin" >> $GITHUB_PATH
          snowsql -v

      - name: Execute SQL (in order)
        if: ${{ inputs.apply == true && inputs.execute_sql == true }}
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ORG_NAME }}-${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWSQL_USER:    ${{ secrets.SNOWFLAKE_USER }}
          SNOWSQL_PWD:     ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWSQL_ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          for f in $(ls build/sql/*.sql | sort); do
            echo "==> $f"
            snowsql -o exit_on_error=true -q "$(cat "$f")"
          done

      # ---- Artifacts ----
      - name: Upload rendered SQL
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-sql
          path: build/sql

      - name: Generate DataHub recipe
        if: ${{ inputs.catalog == true }}
        run: python tools/runner.py catalog --manifest product.yml

      - name: Upload DataHub recipe
        if: ${{ inputs.catalog == true }}
        uses: actions/upload-artifact@v4
        with:
          name: datahub-recipe
          path: build/datahub_snowflake_recipe.yml