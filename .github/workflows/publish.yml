name: Publish Data Product (Manual, Snowflake)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev/uat/prod)"
        required: true
        type: choice
        options: [dev, uat, prod]
        default: dev
      apply:
        description: "Apply Terraform (true) or plan only (false)"
        required: true
        type: boolean
        default: false
      execute_sql:
        description: "Execute rendered SQL with Snowflake CLI"
        required: true
        type: boolean
        default: false
      catalog:
        description: "Generate DataHub recipe artifact"
        required: true
        type: boolean
        default: false
      create_database:
        description: "Create DB from product.yml (needs privilege)"
        required: true
        type: boolean
        default: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      # --- Validate required secrets (minimum set) ---
      - name: Validate required secrets
        env:
          SNOWFLAKE_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          : "${SNOWFLAKE_USER:?Need SNOWFLAKE_USER in this Environment}"
          : "${SNOWFLAKE_PASSWORD:?Need SNOWFLAKE_PASSWORD in this Environment}"
          : "${SNOWFLAKE_ROLE:?Need SNOWFLAKE_ROLE in this Environment}"
          echo "User/password/role secrets present."

      # --- Resolve SNOWFLAKE_ACCOUNT for all subsequent steps ---
      # Prefer the account locator (UE47735) if provided. Otherwise use ORG-ACCOUNT (XYAUPKY-XH85556).
      - name: Resolve SNOWFLAKE_ACCOUNT (locator preferred)
        env:
          LOCATOR:   ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}      # e.g., UE47735 (optional but recommended)
          ORG_NAME:  ${{ secrets.SNOWFLAKE_ORG_NAME }}              # e.g., XYAUPKY
          ACCT_NAME: ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}          # e.g., XH85556
        run: |
          if [ -n "${LOCATOR}" ]; then
            echo "Using account locator: ${LOCATOR}"
            echo "SNOWFLAKE_ACCOUNT=${LOCATOR}" >> "$GITHUB_ENV"
            echo "SNOWFLAKE_REGION=europe-west4.gcp" >> "$GITHUB_ENV"   # required when using locator
          else
            : "${ORG_NAME:?Need SNOWFLAKE_ORG_NAME or SNOWFLAKE_ACCOUNT_LOCATOR in this Environment}"
            : "${ACCT_NAME:?Need SNOWFLAKE_ACCOUNT_NAME or SNOWFLAKE_ACCOUNT_LOCATOR in this Environment}"
            echo "Using org-scoped account: ${ORG_NAME}-${ACCT_NAME}"
            echo "SNOWFLAKE_ACCOUNT=${ORG_NAME}-${ACCT_NAME}" >> "$GITHUB_ENV"
            # Do NOT set SNOWFLAKE_REGION when using ORG-ACCOUNT (Snowflake resolves automatically)
          fi

      # --- Tooling ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI and deps
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          sudo apt-get update && sudo apt-get install -y yq

      # --- Configure Snowflake CLI default connection ---
      # Uses whatever SNOWFLAKE_ACCOUNT was resolved to (locator+region or org-account no region)
      - name: Configure Snowflake CLI default connection
        env:
          SF_ACCOUNT: ${{ env.SNOWFLAKE_ACCOUNT }}
          SF_REGION:  ${{ env.SNOWFLAKE_REGION }}
          SF_USER:    ${{ secrets.SNOWFLAKE_USER }}
          SF_PASS:    ${{ secrets.SNOWFLAKE_PASSWORD }}
          SF_ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          mkdir -p "$HOME/.snowflake"
          {
            echo 'default_connection_name = "ci"'
            echo
            echo "[connections]"
            echo "  [connections.ci]"
            echo "  account  = \"${SF_ACCOUNT}\""
            # only write region if we have one (locator path)
            if [ -n "${SF_REGION}" ]; then
              echo "  region   = \"${SF_REGION}\""
            fi
            echo "  user     = \"${SF_USER}\""
            echo "  password = \"${SF_PASS}\""
            echo "  role     = \"${SF_ROLE}\""
          } > "$HOME/.snowflake/config.toml"
          chmod 600 "$HOME/.snowflake/config.toml"
          echo "Wrote $HOME/.snowflake/config.toml"
          cat "$HOME/.snowflake/config.toml" | sed 's/password = ".*"/password = "***"/'

      # --- Probe Snowflake session identity via CLI ---
      - name: Probe Snowflake session identity (CLI)
        run: |
          snow sql -q "
            SELECT
              CURRENT_ORGANIZATION_NAME() AS ORG,
              CURRENT_ACCOUNT_NAME()      AS ACCT,
              CURRENT_ACCOUNT()           AS ACCOUNT_LOCATOR,
              CURRENT_REGION()            AS REGION,
              CURRENT_USER()              AS USERNAME,
              CURRENT_ROLE()              AS ROLE;
          "

      # --- Terraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Terraform Clean Cache
        working-directory: terraform
        run: |
          rm -rf .terraform .terraform.lock.hcl

      - name: Terraform Init & Validate
        working-directory: terraform
        env:
          SNOWFLAKE_ACCOUNT:  ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_REGION:   ${{ env.SNOWFLAKE_REGION }}
          SNOWFLAKE_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          terraform init -upgrade -reconfigure
          terraform validate

      - name: Debug Snowflake env for TF
        working-directory: terraform
        env:
          SNOWFLAKE_ACCOUNT:  ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_REGION:   ${{ env.SNOWFLAKE_REGION }}
          SNOWFLAKE_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          echo "SNOWFLAKE_ACCOUNT=$SNOWFLAKE_ACCOUNT"
          echo "SNOWFLAKE_REGION=${SNOWFLAKE_REGION:-<unset>}"
          echo "SNOWFLAKE_USER=$SNOWFLAKE_USER"
          echo "SNOWFLAKE_ROLE=$SNOWFLAKE_ROLE"
          test -n "$SNOWFLAKE_ACCOUNT"

      - name: Verify Snowflake connection (same env as TF)
        env:
          SNOWFLAKE_ACCOUNT:  ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_REGION:   ${{ env.SNOWFLAKE_REGION }}
          SNOWFLAKE_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          python - <<'PY'
          import os, snowflake.connector as sf
          con = sf.connect(
            account=os.environ["SNOWFLAKE_ACCOUNT"],
            user=os.environ["SNOWFLAKE_USER"],
            password=os.environ["SNOWFLAKE_PASSWORD"],
            role=os.environ["SNOWFLAKE_ROLE"],
            region=os.environ.get("SNOWFLAKE_REGION")
          )
          cur = con.cursor()
          cur.execute("select current_user(), current_role(), current_account(), current_region()")
          print(cur.fetchone())
          con.close()
          PY

      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_INPUT: "false"
          SNOWFLAKE_ACCOUNT:  ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_REGION:   ${{ env.SNOWFLAKE_REGION }}
          SNOWFLAKE_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "DB from manifest: ${DB_NAME}"
          terraform plan -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Terraform Apply
        if: ${{ github.event.inputs.apply == 'true' }}
        working-directory: terraform
        env:
          TF_INPUT: "false"
          SNOWFLAKE_ACCOUNT:  ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_REGION:   ${{ env.SNOWFLAKE_REGION }}
          SNOWFLAKE_USER:     ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "DB from manifest: ${DB_NAME}"
          terraform apply -auto-approve -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"