name: üöÄ Publish Data Product

# This workflow is triggered manually from the GitHub Actions tab
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run against (e.g., dev, uat, prod)'
        required: true
        default: 'dev'
        type: environment
      apply:
        description: 'Run terraform apply? (true/false)'
        required: true
        default: 'false'
        type: 'boolean'
      # Adding this input based on the repo's README
      execute_sql:
        description: 'Execute rendered SQL files? (true/false)'
        required: true
        default: 'false'
        type: 'boolean'

jobs:
  plan-and-apply:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest

    # 1. CRITICAL FIX:
    # This line tells the job to run inside the GitHub Environment you
    # selected from the dropdown. This is what grants access to the secrets.
    environment: ${{ github.event.inputs.environment }}

    # 2. CRITICAL FIX:
    # This block maps the GitHub Environment Secrets (secrets.SNOWFLAKE_ACCOUNT)
    # to the Environment Variables (SNOWFLAKE_ACCOUNT) that the
    # Terraform Snowflake provider automatically looks for.
    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_REGION: ${{ secrets.SNOWFLAKE_REGION }}
      # This TF_VAR variable is how you pass the DB_NAME to Terraform
      TF_VAR_db_name: ${{ env.DB_NAME_FROM_YML }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: üì¶ Setup yq (for reading product.yml)
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: üìñ Read Database Name from product.yml
        run: |
          DB_NAME=$(yq -r '.layout.database' ./product.yml)
          echo "DB from manifest: $DB_NAME"
          # Export it to be used by the TF_VAR in the main 'env:' block
          echo "DB_NAME_FROM_YML=$DB_NAME" >> $GITHUB_ENV

      - name: üîç Debug Snowflake Credentials
        run: |
          if [ -z "$SNOWFLAKE_ACCOUNT" ]; then
            echo "‚ùå ERROR: SNOWFLAKE_ACCOUNT is empty."
            echo "   Please check your GitHub Environment Secrets."
            exit 1
          else
            echo "‚úÖ SNOWFLAKE_ACCOUNT is set."
          fi

      - name:  Terraform Init
        id: init
        run: terraform init
        working-directory: ./terraform

      - name:  Terraform Plan
        id: plan
        run: terraform plan -no-color
        working-directory: ./terraform

      - name: üöÄ Terraform Apply
        id: apply
        # This step only runs if you selected 'true' for the 'apply' input
        if: github.event.inputs.apply == 'true'
        run: terraform apply -auto-approve -no-color
        working-directory: ./terraform