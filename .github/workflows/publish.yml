name: Publish Data Product (Snowflake + Terraform via profile w/ host)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (dev/uat/prod)"
        required: true
        type: choice
        options: [dev, uat, prod]
        default: dev
      apply:
        description: "Apply Terraform (true) or plan only (false)"
        required: true
        type: boolean
        default: false
      execute_sql:
        description: "Execute rendered SQL with Snowflake CLI"
        required: true
        type: boolean
        default: false
      create_database:
        description: "Create DB from product.yml (needs privilege)"
        required: true
        type: boolean
        default: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Validate required secrets ---
      - name: Validate Snowflake secrets
        env:
          LOCATOR:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }} # e.g., UE47735
          REGION:   ${{ secrets.SNOWFLAKE_REGION }}          # e.g., europe-west4.gcp
          USER:     ${{ secrets.SNOWFLAKE_USER }}            # e.g., CICD_BOT
          PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}            # e.g., CICD_SNOWFLAKE_DEPLOY
        run: |
          : "${LOCATOR:?Missing SNOWFLAKE_ACCOUNT_LOCATOR (e.g. UE47735)}"
          : "${REGION:?Missing SNOWFLAKE_REGION (e.g. europe-west4.gcp)}"
          : "${USER:?Missing SNOWFLAKE_USER}"
          : "${PASSWORD:?Missing SNOWFLAKE_PASSWORD}"
          : "${ROLE:?Missing SNOWFLAKE_ROLE}"
          echo "✅ Secrets present."

      # --- Write both configs with explicit HOST ---
      - name: Write Snowflake configs (provider + CLI)
        env:
          LOCATOR:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          REGION:   ${{ secrets.SNOWFLAKE_REGION }}
          USER:     ${{ secrets.SNOWFLAKE_USER }}
          PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.snowflake"
          HOST="${LOCATOR}.${REGION}.snowflakecomputing.com"

          # 1) Provider profile TOML: ~/.snowflake/config (section [ci])
          # Include host (primary), plus account & region for completeness.
          cat > "$HOME/.snowflake/config" <<EOF
          [ci]
          host     = "${HOST}"
          account  = "${LOCATOR}"
          region   = "${REGION}"
          user     = "${USER}"
          password = "${PASSWORD}"
          role     = "${ROLE}"
          EOF
          chmod 600 "$HOME/.snowflake/config"

          # 2) CLI config TOML: ~/.snowflake/config.toml (connections.ci)
          # snow CLI prefers 'host' when provided.
          cat > "$HOME/.snowflake/config.toml" <<EOF
          default_connection_name = "ci"

          [connections]
            [connections.ci]
            host     = "${HOST}"
            account  = "${LOCATOR}"
            region   = "${REGION}"
            user     = "${USER}"
            password = "${PASSWORD}"
            role     = "${ROLE}"
          EOF
          chmod 600 "$HOME/.snowflake/config.toml"

          # Export for provider
          echo "SNOWFLAKE_CONFIG_PATH=$HOME/.snowflake/config" >> $GITHUB_ENV
          echo "SNOWFLAKE_PROFILE=ci"                          >> $GITHUB_ENV
          # Export for logs
          echo "SF_HOST=${HOST}"                               >> $GITHUB_ENV

      # --- Tooling ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI & yq
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          sudo apt-get update && sudo apt-get install -y yq

      - name: Probe Snowflake identity (CLI)
        run: |
          echo "Connecting to: ${SF_HOST}"
          snow --config-file "$HOME/.snowflake/config.toml" sql -q "
            SELECT
              CURRENT_ACCOUNT() AS ACCOUNT_LOCATOR,
              CURRENT_REGION()  AS REGION,
              CURRENT_USER()    AS USERNAME,
              CURRENT_ROLE()    AS ROLE;"

      # --- Terraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Terraform Init
        working-directory: terraform
        env:
          # Force provider to use the TOML profile (no env guessing)
          SNOWFLAKE_CONFIG_PATH: ${{ env.SNOWFLAKE_CONFIG_PATH }}
          SNOWFLAKE_PROFILE:     ${{ env.SNOWFLAKE_PROFILE }}
        run: |
          rm -rf .terraform .terraform.lock.hcl
          terraform init -upgrade -reconfigure
          terraform validate

      - name: Debug provider profile usage
        working-directory: terraform
        env:
          SNOWFLAKE_CONFIG_PATH: ${{ env.SNOWFLAKE_CONFIG_PATH }}
          SNOWFLAKE_PROFILE:     ${{ env.SNOWFLAKE_PROFILE }}
        run: |
          echo "Using config: $SNOWFLAKE_CONFIG_PATH"
          echo "Using profile: $SNOWFLAKE_PROFILE"
          grep -n "^host"    "$SNOWFLAKE_CONFIG_PATH" || true
          grep -n "^account" "$SNOWFLAKE_CONFIG_PATH" || true
          grep -n "^region"  "$SNOWFLAKE_CONFIG_PATH" || true

      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_INPUT: "false"
          SNOWFLAKE_CONFIG_PATH: ${{ env.SNOWFLAKE_CONFIG_PATH }}
          SNOWFLAKE_PROFILE:     ${{ env.SNOWFLAKE_PROFILE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "DB from manifest: ${DB_NAME}"
          terraform plan -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Terraform Apply
        if: ${{ github.event.inputs.apply == 'true' }}
        working-directory: terraform
        env:
          TF_INPUT: "false"
          SNOWFLAKE_CONFIG_PATH: ${{ env.SNOWFLAKE_CONFIG_PATH }}
          SNOWFLAKE_PROFILE:     ${{ env.SNOWFLAKE_PROFILE }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          echo "Applying for DB: ${DB_NAME}"
          terraform apply -auto-approve -input=false -no-color \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "database_name=${DB_NAME}" \
            -var 'warehouses={"ingest":"CUSTOMER360_INGEST_WH","transform":"CUSTOMER360_TRANSFORM_WH","serve":"CUSTOMER360_SERVE_WH"}' \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Execute SQL after Apply (optional)
        if: ${{ github.event.inputs.apply == 'true' && github.event.inputs.execute_sql == 'true' }}
        run: |
          shopt -s nullglob
          for f in build/sql/*.sql; do
            echo "▶ $f"
            snow --config-file "$HOME/.snowflake/config.toml" sql -f "$f"
          done