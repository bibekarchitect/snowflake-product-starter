name: Publish Data Product (Snowflake via profile)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options: [dev, uat, prod]
        default: dev
      apply:
        description: Apply Terraform (true) or plan only (false)
        required: true
        type: boolean
        default: false
      execute_sql:
        description: Execute rendered SQL with Snowflake CLI
        required: true
        type: boolean
        default: false
      create_database:
        description: Create DB from product.yml (needs privilege)
        required: true
        type: boolean
        default: false
      tf_dir:                    # <— NEW: path to your TF folder
        description: "Terraform directory (repo-relative)"
        required: true
        default: "data-products/customer360/terraform"     # change to e.g. "snowflake/terraform" if that’s your layout


jobs:
  pipeline:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo layout (debug)
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la
          echo "----"
          find . -maxdepth 3 -type d | sort | sed -n '1,200p'

      - name: Resolve Terraform directory
        id: paths
        run: |
          TF_DIR="${{ github.event.inputs.tf_dir }}"
          echo "tf_dir=$TF_DIR" >> "$GITHUB_OUTPUT"
          if [ ! -d "$TF_DIR" ]; then
            echo "::error::Terraform directory '$TF_DIR' does not exist. Please set workflow input 'tf_dir' to the correct path (e.g. 'snowflake/terraform')."
            exit 1
          fi
          echo "✅ Using Terraform dir: $TF_DIR"

    
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      # Write BOTH configs: provider profile (~/.snowflake/config) and CLI (~/.snowflake/config.toml)
      - name: Write Snowflake configs (provider + CLI)
        env:
          LOCATOR:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
          REGION:   ${{ secrets.SNOWFLAKE_REGION }}
          USER:     ${{ secrets.SNOWFLAKE_USER }}
          PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          ROLE:     ${{ secrets.SNOWFLAKE_ROLE }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.snowflake"
          HOST="${LOCATOR}.${REGION}.snowflakecomputing.com"

          echo "Using:"
          echo "  account (locator): ${LOCATOR}"
          echo "  region:            ${REGION}"
          echo "  host:              ${HOST}"
          echo "  user/role:         ${USER}/${ROLE}"

          # --- Provider profile TOML used by Terraform provider ---
          # IMPORTANT: Use keys the provider expects: account, region, user, password, role (host optional).
          cat > "$HOME/.snowflake/config" <<EOF
          [ci]
          account  = "${LOCATOR}"
          region   = "${REGION}"
          user     = "${USER}"
          password = "${PASSWORD}"
          role     = "${ROLE}"
          host     = "${HOST}"
          EOF
          chmod 600 "$HOME/.snowflake/config"

          # --- CLI config TOML used by 'snow' CLI ---
          # Include account, region, host explicitly for all CLI builds.
          cat > "$HOME/.snowflake/config.toml" <<EOF
          default_connection_name = "ci"

          [connections]
            [connections.ci]
            account  = "${LOCATOR}"
            region   = "${REGION}"
            host     = "${HOST}"
            user     = "${USER}"
            password = "${PASSWORD}"
            role     = "${ROLE}"
          EOF
          chmod 600 "$HOME/.snowflake/config.toml"

          # Export ONLY the provider profile path & name for Terraform
          echo "SNOWFLAKE_CONFIG_PATH=$HOME/.snowflake/config" >> $GITHUB_ENV
          echo "SNOWFLAKE_PROFILE=ci"                          >> $GITHUB_ENV

          echo "---- BEGIN ~/.snowflake/config (provider) ----"
          sed -n '1,200p' "$HOME/.snowflake/config"
          echo "---- END ~/.snowflake/config ----"      

      # Tooling
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI & yq
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli
          sudo apt-get update && sudo apt-get install -y yq

      # Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      # CRITICAL: unset any SNOWFLAKE_* env that could override the profile with empties
      - name: Terraform Init
        working-directory: data-products/customer360/terraform
        run: |
          terraform init -upgrade -reconfigure
          terraform validate

      - name: Debug provider profile usage
        working-directory: data-products/customer360/terraform
        env:
          SNOWFLAKE_CONFIG_PATH: ${{ env.SNOWFLAKE_CONFIG_PATH }}
          SNOWFLAKE_PROFILE:     ${{ env.SNOWFLAKE_PROFILE }}
        run: |
          echo "Using provider config: $SNOWFLAKE_CONFIG_PATH"
          echo "Using profile:        $SNOWFLAKE_PROFILE"
          echo "--- begin TOML ---"
          sed -n '1,200p' "$SNOWFLAKE_CONFIG_PATH"
          echo "--- end TOML ---"

      # - name: Preflight — prove CI role can create/drop a WH
      #   env:
      #     LOCATOR:  ${{ secrets.SNOWFLAKE_ACCOUNT_LOCATOR }}
      #     REGION:   ${{ secrets.SNOWFLAKE_REGION }}
      #     USER:     ${{ secrets.SNOWFLAKE_USER }} 
      #     PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      #     ROLE:     ${{ secrets.SNOWFLAKE_ROLE }} 
      #   run: |
      #     python -m pip install --quiet --upgrade snowflake-cli
      #     HOST="${LOCATOR}.${REGION}.snowflakecomputing.com"
      #     mkdir -p "$HOME/.snowflake"
      #     cat > "$HOME/.snowflake/config.toml" <<EOF
      #     default_connection_name = "ci"
      #     [connections.ci]
      #     account  = "${LOCATOR}"
      #     region   = "${REGION}"
      #     host     = "${HOST}"
      #     user     = "${USER}"
      #     password = "${PASSWORD}"
      #     role     = "${ROLE}"
      #     EOF

      #         echo "=== Identity ==="
      #         snow --config-file "$HOME/.snowflake/config.toml" sql -q "
      #           SELECT CURRENT_ACCOUNT() acct, CURRENT_REGION() region, CURRENT_USER() usr, CURRENT_ROLE() rl;"

      #         echo "=== Try CREATE/DROP WAREHOUSE as CI session ==="
      #         snow --config-file "$HOME/.snowflake/config.toml" sql -q "
      #           CREATE WAREHOUSE IF NOT EXISTS TF_PRIV_CHECK_WH
      #             WAREHOUSE_SIZE='XSMALL' AUTO_SUSPEND=60 AUTO_RESUME=TRUE;
      #           DROP WAREHOUSE IF EXISTS TF_PRIV_CHECK_WH;"

      - name: Terraform Plan
        working-directory: data-products/customer360/terraform
        env:
          TF_VAR_snowflake_org:     ${{ secrets.SNOWFLAKE_ORG }}
          TF_VAR_snowflake_account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          TF_VAR_snowflake_user:    ${{ secrets.SNOWFLAKE_USER }}
          TF_VAR_snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }} # Recommended
          TF_VAR_snowflake_role:    ${{ secrets.SNOWFLAKE_ROLE }}
          TF_VAR_svc_admin_user:    ${{ secrets.ADMIN_USER }}
          TF_VAR_svc_admin_password: ${{ secrets.ADMIN_USER_PASSWORD }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          terraform plan -no-color -input=false \
            -var "database_name=${DB_NAME}" \
            -var "create_database=${{ github.event.inputs.create_database }}" \
            -var "resource_monitor_name=RM_CUSTOMER360"

      - name: Terraform Apply
        if: ${{ github.event.inputs.apply == 'true' }}
        working-directory: data-products/customer360/terraform
        env:
          TF_VAR_snowflake_org:     ${{ secrets.SNOWFLAKE_ORG }}
          TF_VAR_snowflake_account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          TF_VAR_snowflake_user:    ${{ secrets.SNOWFLAKE_USER }}
          TF_VAR_snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }} # Recommended
          TF_VAR_snowflake_role:    ${{ secrets.SNOWFLAKE_ROLE }}
          TF_VAR_svc_admin_user:    ${{ secrets.ADMIN_USER }}
          TF_VAR_svc_admin_password: ${{ secrets.ADMIN_USER_PASSWORD }}
        run: |
          DB_NAME="$(yq -r '.layout.database' ../product.yml)"
          terraform apply -auto-approve -no-color -input=false \
             -var "database_name=${DB_NAME}" \
             -var "create_database=${{ github.event.inputs.create_database }}" \
             -var "resource_monitor_name=RM_CUSTOMER360"
            
            

      # Optional: execute SQL scripts after apply
      - name: Execute SQL scripts via Snowflake CLI
        if: ${{ github.event.inputs.apply == 'true' && github.event.inputs.execute_sql == 'true' }}
        run: |
          shopt -s nullglob
          for f in build/sql/*.sql; do
            echo "▶ $f"
            snow --config-file "$HOME/.snowflake/config.toml" sql -f "$f"
          done